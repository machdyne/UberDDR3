# Generated by https://github.com/FPGAOL-CE/caas-wizard
DB_DIR = /usr/local/share/prjxray/artix7

BUILDDIR := ${CURDIR}/build
TOP := sechzig_mx2_ddr3
#SOURCES :=  $(wildcard *.v ../../rtl/ddr3*.v)
XDC := $(wildcard  $(wildcard sechzig_mx2.xdc) )

CHIPFAM := artix7
PART := xc7a35tftg256
PARTFULL := xc7a35tftg256-2

LOGFILE := ${BUILDDIR}/top.log

all: ${BUILDDIR} ${BUILDDIR}/top.bit

${BUILDDIR}:
	mkdir -m 777 -p ${BUILDDIR} && chown -R nobody ${BUILDDIR} | true

# we run this in parent directory to seeminglessly import user source files
# otherwise have to parse user pattern and add ../
${BUILDDIR}/top.json:  $(wildcard *.v)  $(wildcard ../../rtl/*.v)  
	yosys -p "synth_xilinx -flatten -abc9 -arch xc7 -top ${TOP}; write_json ${BUILDDIR}/top.json" $^ >> ${LOGFILE} 2>&1

${BUILDDIR}/top.fasm: ${BUILDDIR}/top.json
	nextpnr-xilinx --chipdb ${DB_DIR}/../${PART}.bin --xdc ${XDC} --json ${BUILDDIR}/top.json --pre-place constraints.py --pre-route show_bels.py --fasm $@ >> ${LOGFILE} 2>&1

${BUILDDIR}/top.frames: ${BUILDDIR}/top.fasm
	fasm2frames --part ${PARTFULL} --db-root ${DB_DIR} $< > $@

${BUILDDIR}/top.bit: ${BUILDDIR}/top.frames
	xc7frames2bit --part_file ${DB_DIR}/${CHIPFAM}/${PARTFULL}/part.yaml --part_name ${PARTFULL} --frm_file $< --output_file $@ >> ${LOGFILE} 2>&1

.PHONY: clean
clean:
	@rm -f *.bit
	@rm -f *.frames
	@rm -f *.fasm
	@rm -f *.json
